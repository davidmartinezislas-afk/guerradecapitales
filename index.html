<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0e1a">
    <meta name="format-detection" content="telephone=no">
    <title>Guerra de Capitales</title>
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-388L84LGMZ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-388L84LGMZ');
    </script>
    
    <style>
/* Reset b√°sico */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', system-ui, sans-serif;
    background: #0a0e1a;
    color: #ffffff;
    height: 100svh;
    height: 100dvh;
    overflow: hidden;
    position: fixed;
    width: 100%;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
}

/* Sistema de pantallas */
.screen {
    display: none !important;
    height: 100svh;
    height: 100dvh;
    width: 100%;
    padding: 0;
    position: relative;
    overflow: hidden;
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
}

.screen.active {
    display: block !important;
}

.container {
    max-width: 500px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    height: 100%;
    padding: max(24px, env(safe-area-inset-top)) max(20px, env(safe-area-inset-right)) max(24px, env(safe-area-inset-bottom)) max(20px, env(safe-area-inset-left));
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
}

/* Ajuste espec√≠fico para pantalla de dificultad */
#screen-difficulty .container {
    justify-content: space-between;
    padding-top: 40px;
    padding-bottom: 40px;
}

#screen-difficulty .logo {
    padding-top: 0;
    margin-bottom: 32px;
}

/* Pantalla de Inicio */
.logo {
    text-align: center;
    margin-bottom: auto;
    padding-top: max(60px, env(safe-area-inset-top) + 20px);
}

.logo h1 {
    font-size: 48px;
    font-weight: 800;
    margin-bottom: 12px;
    letter-spacing: -0.5px;
    line-height: 1.2;
}

.subtitle {
    font-size: 16px;
    color: #b0b8c8;
    font-weight: 400;
    letter-spacing: 0.2px;
}

.start-content {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-top: auto;
    padding-bottom: max(40px, env(safe-area-inset-bottom) + 20px);
}

/* Modo de juego selector */
.game-mode-selector {
    background: rgba(30, 35, 56, 0.8);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border: 0.5px solid rgba(255, 255, 255, 0.1);
    border-radius: 14px;
    padding: 14px 16px;
    text-align: center;
    margin-bottom: 8px;
    color: #b0b8c8;
    font-size: 15px;
    font-weight: 500;
}

.game-mode-selector .vs {
    color: #5a9fd4;
    font-weight: 700;
    margin: 0 8px;
}

/* Pantalla de Estad√≠sticas */
.stats-screen-content {
    display: flex;
    flex-direction: column;
    gap: 24px;
}

.stats-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.stats-header h2 {
    font-size: 28px;
    font-weight: 700;
    color: #ffffff;
    margin: 0;
}

/* Tarjeta de Estad√≠sticas */
.stats-card {
    background: rgba(22, 33, 62, 0.6);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(102, 126, 234, 0.2);
    border-radius: 20px;
    padding: 24px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.stats-table {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.stats-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #2d3748;
}

.stats-row:last-child {
    border-bottom: none;
}

.stats-label {
    font-size: 15px;
    color: #a0aec0;
}

.stats-value {
    font-size: 18px;
    font-weight: 700;
    color: #ffffff;
}

.game-info {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.info-card {
    background: rgba(22, 33, 62, 0.6);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(102, 126, 234, 0.2);
    border-radius: 20px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
}

.info-card:hover {
    border-color: rgba(102, 126, 234, 0.4);
    transform: translateY(-2px);
    box-shadow: 0 6px 30px rgba(102, 126, 234, 0.15);
}

.info-icon {
    font-size: 32px;
    flex-shrink: 0;
}

.info-card p {
    font-size: 16px;
    margin: 0;
}

/* Botones */
.btn {
    padding: 18px 32px;
    border: none;
    border-radius: 14px;
    font-size: 17px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    text-align: center;
    display: block;
    width: 100%;
    position: relative;
    overflow: hidden;
    letter-spacing: -0.2px;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
}

.btn-primary {
    background: #007AFF;
    color: #ffffff;
    box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
    border: none;
}

.btn-primary:active {
    background: #0051D5;
    transform: scale(0.98);
    box-shadow: 0 1px 4px rgba(0, 122, 255, 0.2);
}

.btn-primary:active {
    transform: scale(0.97);
    box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
}

.btn-secondary {
    background: rgba(30, 35, 56, 0.8);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    color: #ffffff;
    border: 0.5px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.btn-secondary:active {
    transform: scale(0.98);
    background: rgba(30, 35, 56, 0.9);
}

.btn-stats {
    background: rgba(30, 35, 56, 0.8);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    color: #ffffff;
    border: 0.5px solid rgba(255, 255, 255, 0.1);
    padding: 16px 24px;
    font-size: 16px;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.btn-stats:active {
    transform: scale(0.98);
    background: rgba(30, 35, 56, 0.9);
}

.btn-icon {
    background: transparent;
    border: none;
    color: #ffffff;
    font-size: 24px;
    cursor: pointer;
    padding: 8px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-icon:active {
    opacity: 0.7;
}

/* Pantalla de Juego */
.game-container {
    max-width: 500px;
    margin: 0 auto;
    height: 100%;
    display: flex;
    flex-direction: column;
    padding: 0 20px;
    overflow: hidden;
}

.game-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 0;
    margin-bottom: 16px;
    flex-shrink: 0;
}

.game-title {
    font-size: 18px;
    font-weight: 700;
    flex: 1;
    text-align: center;
    color: #a0aec0;
    letter-spacing: 0.5px;
}

.scores {
    background: rgba(22, 33, 62, 0.6);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(102, 126, 234, 0.2);
    border-radius: 24px;
    padding: 20px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    justify-content: space-around;
    gap: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    flex-shrink: 0;
}

.score-item {
    flex: 1;
    text-align: center;
}

.score-label {
    font-size: 14px;
    color: #a0aec0;
    margin-bottom: 8px;
}

.score-value {
    font-size: 32px;
    font-weight: 700;
}

.player-score .score-value {
    color: #667eea;
}

.ai-score .score-value {
    color: #f56565;
}

.vs-divider {
    font-size: 18px;
    font-weight: 700;
    color: #a0aec0;
}

.game-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 20px;
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 20px;
}

.question-card {
    background: rgba(22, 33, 62, 0.6);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(102, 126, 234, 0.2);
    border-radius: 24px;
    padding: 32px 24px;
    text-align: center;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    flex-shrink: 0;
}

.question-card h2 {
    font-size: 20px;
    margin-bottom: 16px;
    color: #a0aec0;
}

.country-name {
    font-size: 32px;
    font-weight: 700;
    color: #ffffff;
    margin-bottom: 16px;
}

/* Timer bar */
.timer-container {
    width: 100%;
    height: 6px;
    background: rgba(45, 55, 72, 0.5);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 20px;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
}

.timer-bar {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    width: 100%;
    transition: width 0.05s linear;
    border-radius: 3px;
    box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
}

.timer-bar.warning {
    background: linear-gradient(90deg, #f56565 0%, #e53e3e 100%);
    box-shadow: 0 0 15px rgba(245, 101, 101, 0.6);
    animation: timer-pulse 0.5s ease-in-out infinite;
}

@keyframes timer-pulse {
    0%, 100% {
        box-shadow: 0 0 15px rgba(245, 101, 101, 0.6);
    }
    50% {
        box-shadow: 0 0 25px rgba(245, 101, 101, 0.8);
    }
}

/* Countdown overlay */
.countdown-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(26, 26, 46, 0.95);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.countdown-overlay.show {
    display: flex;
}

.countdown-text {
    font-size: 140px;
    font-weight: 800;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: 0 0 40px rgba(102, 126, 234, 0.6);
    animation: countdownPulse 0.3s ease;
    filter: drop-shadow(0 0 30px rgba(102, 126, 234, 0.5));
}

@keyframes countdownPulse {
    0% {
        transform: scale(0.5);
        opacity: 0;
    }
    50% {
        transform: scale(1.2);
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

/* Grid de respuestas tipo Kahoot (2x2) */
.answers-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    width: 100%;
}

.ans-btn {
    background: rgba(22, 33, 62, 0.7);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(102, 126, 234, 0.3);
    border-radius: 20px;
    padding: 24px 20px;
    color: #ffffff;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    text-align: center;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    min-height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
}

.ans-btn:active:not(.disabled) {
    transform: scale(0.95);
}

.ans-btn:not(.disabled):hover {
    border-color: rgba(102, 126, 234, 0.6);
    transform: translateY(-2px);
    box-shadow: 0 6px 24px rgba(102, 126, 234, 0.3);
}

.ans-btn.correct {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    border-color: #38a169;
    color: #ffffff;
    box-shadow: 0 8px 32px rgba(72, 187, 120, 0.5), 0 0 20px rgba(72, 187, 120, 0.3);
    animation: correct-glow 0.6s ease-out;
}

@keyframes correct-glow {
    0% {
        box-shadow: 0 8px 32px rgba(72, 187, 120, 0.5), 0 0 20px rgba(72, 187, 120, 0.3);
    }
    50% {
        box-shadow: 0 8px 40px rgba(72, 187, 120, 0.7), 0 0 30px rgba(72, 187, 120, 0.5);
    }
    100% {
        box-shadow: 0 8px 32px rgba(72, 187, 120, 0.5), 0 0 20px rgba(72, 187, 120, 0.3);
    }
}

.ans-btn.wrong {
    background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
    border-color: #e53e3e;
    color: #ffffff;
    box-shadow: 0 8px 32px rgba(245, 101, 101, 0.5), 0 0 20px rgba(245, 101, 101, 0.3);
    animation: wrong-shake 0.5s ease-out;
}

@keyframes wrong-shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-8px); }
    75% { transform: translateX(8px); }
}

.ans-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}

.result-message {
    background: #16213e;
    border-radius: 16px;
    padding: 20px;
    text-align: center;
    min-height: 60px;
    display: none;
}

.result-message.show {
    display: block;
}

/* Pantalla de Resultado */
.result-content {
    text-align: center;
    display: flex;
    flex-direction: column;
    height: 100%;
    justify-content: center;
}

.result-icon {
    font-size: 100px;
    margin-bottom: 24px;
    animation: result-bounce 0.6s ease-out;
    filter: drop-shadow(0 0 20px rgba(102, 126, 234, 0.5));
}

@keyframes result-bounce {
    0% {
        transform: scale(0);
        opacity: 0;
    }
    50% {
        transform: scale(1.2);
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

.result-content h1 {
    font-size: 42px;
    margin-bottom: 12px;
    font-weight: 800;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.5px;
}

.result-content p {
    font-size: 18px;
    color: #a0aec0;
    margin-bottom: 20px;
}

.result-phrase {
    font-size: 18px;
    color: #a0aec0;
    font-weight: 500;
    margin-bottom: 40px;
    padding: 20px;
    line-height: 1.6;
    background: rgba(22, 33, 62, 0.4);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    border: 1px solid rgba(102, 126, 234, 0.2);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
}

.final-stats {
    background: rgba(22, 33, 62, 0.6);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(102, 126, 234, 0.2);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 32px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #2d3748;
}

.stat-item:last-child {
    border-bottom: none;
}

.stat-label {
    font-size: 16px;
    color: #a0aec0;
}

.stat-value {
    font-size: 20px;
    font-weight: 700;
}

.result-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

/* Pantalla de Dificultad */
.difficulty-options {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 32px;
}

.difficulty-btn {
    background: rgba(22, 33, 62, 0.6);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(102, 126, 234, 0.3);
    border-radius: 20px;
    padding: 24px;
    color: #ffffff;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    text-align: left;
    display: flex;
    align-items: flex-start;
    gap: 16px;
    width: 100%;
    opacity: 0;
    transform: translateY(20px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
}

.difficulty-btn.slide-up {
    animation: slideUpFade 0.5s ease forwards;
}

@keyframes slideUpFade {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.difficulty-btn:active {
    transform: scale(0.98) translateY(0);
}

.difficulty-btn:hover {
    border-color: rgba(102, 126, 234, 0.6);
    background: rgba(26, 37, 64, 0.8);
    transform: translateY(-2px);
    box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
}

.difficulty-icon-wrapper {
    padding: 12px;
    border-radius: 14px;
    background: rgba(45, 55, 72, 0.6);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: transform 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.difficulty-btn:hover .difficulty-icon-wrapper {
    transform: scale(1.1);
}

.difficulty-icon-wrapper.difficulty-novice {
    color: #48bb78;
}

.difficulty-icon-wrapper.difficulty-intermediate {
    color: #f6ad55;
}

.difficulty-icon-wrapper.difficulty-expert {
    color: #f56565;
}

.difficulty-icon {
    font-size: 24px;
    display: block;
}

.difficulty-info {
    flex: 1;
}

.difficulty-name {
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 6px;
}

.difficulty-name.difficulty-novice {
    color: #48bb78;
}

.difficulty-name.difficulty-intermediate {
    color: #f6ad55;
}

.difficulty-name.difficulty-expert {
    color: #f56565;
}

.difficulty-desc {
    font-size: 14px;
    color: #a0aec0;
    line-height: 1.5;
}

.difficulty-hint {
    text-align: center;
    margin-top: auto;
    padding-top: 24px;
}

.difficulty-hint p {
    font-size: 14px;
    color: #a0aec0;
    margin: 0;
}

/* Responsive - Tablets y desktop */
@media (min-width: 768px) {
    .container {
        max-width: 600px;
    }
    
    .game-container {
        max-width: 600px;
    }
    
    .answers-grid {
        gap: 20px;
    }
    
    .ans-btn {
        min-height: 80px;
        font-size: 20px;
    }
}
    </style>
</head>
<body>
    <!-- Pantalla de Inicio -->
    <div id="screen-start" class="screen active">
        <div class="container">
            <div class="logo">
                <div style="text-align: center; margin-bottom: 16px;">
                    <div style="width: 80px; height: 80px; margin: 0 auto 16px; border: 2px solid #5a9fd4; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <span style="font-size: 40px; color: #5a9fd4;">üåç</span>
                    </div>
                </div>
                <h1><span style="color: #a0b4d4;">Guerra de </span><span style="color: #ffd700;">Capitales</span></h1>
                <p class="subtitle">Demuestra cu√°nto sabes del mundo</p>
            </div>
            
            <div class="start-content">
                <div class="game-mode-selector">
                    <span>Jugador</span> <span class="vs">VS</span> <span>IA</span>
                </div>
                
                <button id="btn-start" class="btn btn-primary">
                    <span style="margin-right: 8px;">‚ñ∂</span>
                    Comenzar
                </button>
                
                <button id="btn-stats" class="btn btn-stats">
                    <span style="margin-right: 8px;">üèÜ</span>
                    R√©cord
                </button>
            </div>
        </div>
    </div>

    <!-- Pantalla de R√©cord de Guerra -->
    <div id="screen-stats" class="screen">
        <div class="container">
            <div class="stats-screen-content">
                <div class="stats-header">
                    <h2>üèÜ R√©cord de Guerra</h2>
                    <button id="btn-close-stats" class="btn-icon">‚úï</button>
                </div>
                
                <div class="stats-card">
                    <div class="stats-table">
                        <div class="stats-row">
                            <span class="stats-label">Partidas jugadas</span>
                            <span class="stats-value" id="stat-games-played">0</span>
                        </div>
                        <div class="stats-row">
                            <span class="stats-label">Victorias</span>
                            <span class="stats-value" id="stat-games-won">0</span>
                        </div>
                        <div class="stats-row">
                            <span class="stats-label">Derrotas</span>
                            <span class="stats-value" id="stat-games-lost">0</span>
                        </div>
                        <div class="stats-row">
                            <span class="stats-label">Empates</span>
                            <span class="stats-value" id="stat-games-draw">0</span>
                        </div>
                        <div class="stats-row">
                            <span class="stats-label">Ratio de victoria</span>
                            <span class="stats-value" id="stat-win-rate">‚Äî</span>
                        </div>
                    </div>
                </div>
                
                <button id="btn-close-stats-bottom" class="btn btn-secondary">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Pantalla de Selecci√≥n de Dificultad -->
    <div id="screen-difficulty" class="screen">
        <div class="container">
            <div class="logo">
                <h1>Elige tu nivel</h1>
            </div>
            
            <div class="difficulty-options">
                <button class="difficulty-btn slide-up" data-difficulty="beginner" style="animation-delay: 0s;">
                    <div class="difficulty-icon-wrapper difficulty-novice">
                        <span class="difficulty-icon">‚ö°</span>
                    </div>
                    <div class="difficulty-info">
                        <div class="difficulty-name difficulty-novice">Novato</div>
                        <div class="difficulty-desc">Para calentar motores. Aprende el ritmo del juego.</div>
                    </div>
                </button>
                
                <button class="difficulty-btn slide-up" data-difficulty="intermediate" style="animation-delay: 0.1s;">
                    <div class="difficulty-icon-wrapper difficulty-intermediate">
                        <span class="difficulty-icon">üî•</span>
                    </div>
                    <div class="difficulty-info">
                        <div class="difficulty-name difficulty-intermediate">Intermedio</div>
                        <div class="difficulty-desc">Buen reto. Aqu√≠ se separan los que saben.</div>
                    </div>
                </button>
                
                <button class="difficulty-btn slide-up" data-difficulty="advanced" style="animation-delay: 0.2s;">
                    <div class="difficulty-icon-wrapper difficulty-expert">
                        <span class="difficulty-icon">üíÄ</span>
                    </div>
                    <div class="difficulty-info">
                        <div class="difficulty-name difficulty-expert">Especialista</div>
                        <div class="difficulty-desc">Modo experto. Solo para quienes dominan el mapa.</div>
                    </div>
                </button>
            </div>
            
            <!-- Hint al final -->
            <div class="difficulty-hint">
                <p>Cuanto mayor el nivel, menos tiempo para responder</p>
            </div>
        </div>
    </div>

    <!-- Pantalla de Juego -->
    <div id="screen-game" class="screen">
        <div class="game-container">
            <!-- Header del juego -->
            <header class="game-header">
                <button id="btn-back" class="btn-icon" title="Volver al inicio">‚Üê</button>
                <div class="game-title">Ronda <span id="round-label">1</span></div>
                <div class="btn-icon"></div>
            </header>

            <!-- Puntuaciones -->
            <div class="scores">
                <div class="score-item player-score">
                    <div class="score-label">T√∫</div>
                    <div class="score-value" id="score-player">0</div>
                </div>
                
                <div class="vs-divider">VS</div>
                
                <div class="score-item ai-score">
                    <div class="score-label">IA</div>
                    <div class="score-value" id="score-ai">0</div>
                </div>
            </div>

            <!-- √Årea de juego principal -->
            <div class="game-main">
                <!-- Countdown overlay -->
                <div id="countdown-overlay" class="countdown-overlay">
                    <div id="countdown-text" class="countdown-text">3</div>
                </div>

                <div class="question-card">
                    <h2 id="question-text">¬øCu√°l es la capital de...?</h2>
                    <p id="country-name" class="country-name"></p>
                    <!-- Timer bar -->
                    <div class="timer-container">
                        <div id="timer-bar" class="timer-bar"></div>
                    </div>
                </div>

                <!-- Opciones de respuesta tipo Kahoot (Grid 2x2) -->
                <div id="answers" class="answers-grid">
                    <!-- Las opciones se generan din√°micamente -->
                </div>

                <!-- Mensaje de resultado -->
                <div class="result-message" id="result-message">
                    <!-- Se muestra despu√©s de cada respuesta -->
                </div>
            </div>
        </div>
    </div>

    <!-- Pantalla de Resultado -->
    <div id="screen-result" class="screen">
        <div class="container">
            <div class="result-content">
                <div class="result-icon" id="result-icon">üéâ</div>
                <h1 id="result-title">¬°Victoria!</h1>
                <p id="result-message-text">Has ganado la guerra de capitales</p>
                <p id="result-phrase" class="result-phrase"></p>
                
                <div class="final-stats">
                    <div class="stat-item">
                        <span class="stat-label">Tu Puntuaci√≥n</span>
                        <span class="stat-value" id="final-player-score">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Puntuaci√≥n de la IA</span>
                        <span class="stat-value" id="final-ai-score">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Rondas Jugadas</span>
                        <span class="stat-value" id="final-rounds">0</span>
                    </div>
                </div>

                <div class="result-actions">
                    <button id="btn-play-again" class="btn btn-primary">Jugar de Nuevo</button>
                    <button id="btn-go-home" class="btn btn-secondary">Inicio</button>
                </div>
            </div>
        </div>
    </div>

    <script>
// ============================================
// DATA.JS - Lista de pa√≠ses y capitales (120+)
// ============================================
const QA = [
    // Tier: famosa
    { country: "Espa√±a", capital: "Madrid", tier: "famosa" },
    { country: "Francia", capital: "Par√≠s", tier: "famosa" },
    { country: "Italia", capital: "Roma", tier: "famosa" },
    { country: "Alemania", capital: "Berl√≠n", tier: "famosa" },
    { country: "Reino Unido", capital: "Londres", tier: "famosa" },
    { country: "Jap√≥n", capital: "Tokio", tier: "famosa" },
    { country: "M√©xico", capital: "Ciudad de M√©xico", tier: "famosa" },
    { country: "Canad√°", capital: "Ottawa", tier: "famosa" },
    { country: "Brasil", capital: "Brasilia", tier: "famosa" },
    { country: "Argentina", capital: "Buenos Aires", tier: "famosa" },
    { country: "China", capital: "Pek√≠n", tier: "famosa" },
    { country: "India", capital: "Nueva Delhi", tier: "famosa" },
    { country: "Australia", capital: "Canberra", tier: "famosa" },
    { country: "Rusia", capital: "Mosc√∫", tier: "famosa" },
    { country: "Estados Unidos", capital: "Washington D.C.", tier: "famosa" },
    { country: "Egipto", capital: "El Cairo", tier: "famosa" },
    { country: "Grecia", capital: "Atenas", tier: "famosa" },
    { country: "Turqu√≠a", capital: "Ankara", tier: "famosa" },
    { country: "Corea del Sur", capital: "Se√∫l", tier: "famosa" },
    { country: "Tailandia", capital: "Bangkok", tier: "famosa" },
    // Tier: media
    { country: "Portugal", capital: "Lisboa", tier: "media" },
    { country: "Polonia", capital: "Varsovia", tier: "media" },
    { country: "Holanda", capital: "√Åmsterdam", tier: "media" },
    { country: "B√©lgica", capital: "Bruselas", tier: "media" },
    { country: "Suiza", capital: "Berna", tier: "media" },
    { country: "Austria", capital: "Viena", tier: "media" },
    { country: "Suecia", capital: "Estocolmo", tier: "media" },
    { country: "Noruega", capital: "Oslo", tier: "media" },
    { country: "Dinamarca", capital: "Copenhague", tier: "media" },
    { country: "Finlandia", capital: "Helsinki", tier: "media" },
    { country: "Irlanda", capital: "Dubl√≠n", tier: "media" },
    { country: "Rep√∫blica Checa", capital: "Praga", tier: "media" },
    { country: "Hungr√≠a", capital: "Budapest", tier: "media" },
    { country: "Ruman√≠a", capital: "Bucarest", tier: "media" },
    { country: "Chile", capital: "Santiago", tier: "media" },
    { country: "Colombia", capital: "Bogot√°", tier: "media" },
    { country: "Per√∫", capital: "Lima", tier: "media" },
    { country: "Venezuela", capital: "Caracas", tier: "media" },
    { country: "Ecuador", capital: "Quito", tier: "media" },
    { country: "Indonesia", capital: "Yakarta", tier: "media" },
    { country: "Filipinas", capital: "Manila", tier: "media" },
    { country: "Vietnam", capital: "Han√≥i", tier: "media" },
    { country: "Malasia", capital: "Kuala Lumpur", tier: "media" },
    { country: "Singapur", capital: "Singapur", tier: "media" },
    { country: "Sud√°frica", capital: "Pretoria", tier: "media" },
    { country: "Marruecos", capital: "Rabat", tier: "media" },
    { country: "Israel", capital: "Jerusal√©n", tier: "media" },
    { country: "Arabia Saud√≠", capital: "Riad", tier: "media" },
    { country: "Ir√°n", capital: "Teher√°n", tier: "media" },
    { country: "Irak", capital: "Bagdad", tier: "media" },
    // Tier: dificil
    { country: "Croacia", capital: "Zagreb", tier: "dificil" },
    { country: "Serbia", capital: "Belgrado", tier: "dificil" },
    { country: "Bulgaria", capital: "Sof√≠a", tier: "dificil" },
    { country: "Eslovaquia", capital: "Bratislava", tier: "dificil" },
    { country: "Eslovenia", capital: "Liubliana", tier: "dificil" },
    { country: "Lituania", capital: "Vilna", tier: "dificil" },
    { country: "Letonia", capital: "Riga", tier: "dificil" },
    { country: "Estonia", capital: "Tallin", tier: "dificil" },
    { country: "Ucrania", capital: "Kiev", tier: "dificil" },
    { country: "Bielorrusia", capital: "Minsk", tier: "dificil" },
    { country: "Uruguay", capital: "Montevideo", tier: "dificil" },
    { country: "Paraguay", capital: "Asunci√≥n", tier: "dificil" },
    { country: "Bolivia", capital: "Sucre", tier: "dificil" },
    { country: "Panam√°", capital: "Ciudad de Panam√°", tier: "dificil" },
    { country: "Costa Rica", capital: "San Jos√©", tier: "dificil" },
    { country: "Guatemala", capital: "Ciudad de Guatemala", tier: "dificil" },
    { country: "Honduras", capital: "Tegucigalpa", tier: "dificil" },
    { country: "El Salvador", capital: "San Salvador", tier: "dificil" },
    { country: "Nicaragua", capital: "Managua", tier: "dificil" },
    { country: "Cuba", capital: "La Habana", tier: "dificil" },
    { country: "Rep√∫blica Dominicana", capital: "Santo Domingo", tier: "dificil" },
    { country: "Jamaica", capital: "Kingston", tier: "dificil" },
    { country: "Hait√≠", capital: "Puerto Pr√≠ncipe", tier: "dificil" },
    { country: "Myanmar", capital: "Naipyid√≥", tier: "dificil" },
    { country: "Camboya", capital: "Phnom Penh", tier: "dificil" },
    { country: "Laos", capital: "Vienti√°n", tier: "dificil" },
    { country: "Bangladesh", capital: "Daca", tier: "dificil" },
    { country: "Sri Lanka", capital: "Sri Jayawardenapura Kotte", tier: "dificil" },
    { country: "Nepal", capital: "Katmand√∫", tier: "dificil" },
    { country: "But√°n", capital: "Timbu", tier: "dificil" },
    { country: "Kenia", capital: "Nairobi", tier: "dificil" },
    { country: "Nigeria", capital: "Abuya", tier: "dificil" },
    { country: "Ghana", capital: "Acra", tier: "dificil" },
    { country: "Senegal", capital: "Dakar", tier: "dificil" },
    { country: "T√∫nez", capital: "T√∫nez", tier: "dificil" },
    { country: "Argelia", capital: "Argel", tier: "dificil" },
    { country: "Libia", capital: "Tr√≠poli", tier: "dificil" },
    { country: "Jordania", capital: "Am√°n", tier: "dificil" },
    { country: "L√≠bano", capital: "Beirut", tier: "dificil" },
    { country: "Siria", capital: "Damasco", tier: "dificil" },
    // Tier: muy_dificil
    { country: "Islandia", capital: "Reikiavik", tier: "muy_dificil" },
    { country: "Luxemburgo", capital: "Luxemburgo", tier: "muy_dificil" },
    { country: "M√≥naco", capital: "M√≥naco", tier: "muy_dificil" },
    { country: "Andorra", capital: "Andorra la Vieja", tier: "muy_dificil" },
    { country: "San Marino", capital: "San Marino", tier: "muy_dificil" },
    { country: "Liechtenstein", capital: "Vaduz", tier: "muy_dificil" },
    { country: "Malta", capital: "La Valeta", tier: "muy_dificil" },
    { country: "Chipre", capital: "Nicosia", tier: "muy_dificil" },
    { country: "Albania", capital: "Tirana", tier: "muy_dificil" },
    { country: "Macedonia del Norte", capital: "Skopie", tier: "muy_dificil" },
    { country: "Montenegro", capital: "Podgorica", tier: "muy_dificil" },
    { country: "Bosnia y Herzegovina", capital: "Sarajevo", tier: "muy_dificil" },
    { country: "Moldavia", capital: "Chisin√°u", tier: "muy_dificil" },
    { country: "Georgia", capital: "Tiflis", tier: "muy_dificil" },
    { country: "Armenia", capital: "Erev√°n", tier: "muy_dificil" },
    { country: "Azerbaiy√°n", capital: "Bak√∫", tier: "muy_dificil" },
    { country: "Kazajist√°n", capital: "Nursult√°n", tier: "muy_dificil" },
    { country: "Uzbekist√°n", capital: "Taskent", tier: "muy_dificil" },
    { country: "Kirguist√°n", capital: "Biskek", tier: "muy_dificil" },
    { country: "Tayikist√°n", capital: "Dusamb√©", tier: "muy_dificil" },
    { country: "Turkmenist√°n", capital: "Asjabad", tier: "muy_dificil" },
    { country: "Mongolia", capital: "Ul√°n Bator", tier: "muy_dificil" },
    { country: "Nueva Zelanda", capital: "Wellington", tier: "muy_dificil" },
    { country: "Fiyi", capital: "Suva", tier: "muy_dificil" },
    { country: "Pap√∫a Nueva Guinea", capital: "Puerto Moresby", tier: "muy_dificil" },
    { country: "Brun√©i", capital: "Bandar Seri Begawan", tier: "muy_dificil" },
    { country: "Timor Oriental", capital: "Dili", tier: "muy_dificil" },
    { country: "Afganist√°n", capital: "Kabul", tier: "muy_dificil" },
    { country: "Pakist√°n", capital: "Islamabad", tier: "muy_dificil" },
    { country: "Yemen", capital: "San√°", tier: "muy_dificil" },
    { country: "Om√°n", capital: "Mascate", tier: "muy_dificil" },
    { country: "Emiratos √Årabes Unidos", capital: "Abu Dabi", tier: "muy_dificil" },
    { country: "Kuwait", capital: "Kuwait", tier: "muy_dificil" },
    { country: "Bar√©in", capital: "Manama", tier: "muy_dificil" },
    { country: "Qatar", capital: "Doha", tier: "muy_dificil" },
    { country: "Etiop√≠a", capital: "Ad√≠s Abeba", tier: "muy_dificil" },
    { country: "Tanzania", capital: "Dodoma", tier: "muy_dificil" },
    { country: "Uganda", capital: "Kampala", tier: "muy_dificil" },
    { country: "Ruanda", capital: "Kigali", tier: "muy_dificil" },
    { country: "Burundi", capital: "Gitega", tier: "muy_dificil" },
    { country: "Malaui", capital: "Lilong√ºe", tier: "muy_dificil" },
    { country: "Zambia", capital: "Lusaka", tier: "muy_dificil" },
    { country: "Zimbabue", capital: "Harare", tier: "muy_dificil" },
    { country: "Botsuana", capital: "Gaborone", tier: "muy_dificil" },
    { country: "Namibia", capital: "Windhoek", tier: "muy_dificil" },
    { country: "Mozambique", capital: "Maputo", tier: "muy_dificil" },
    { country: "Madagascar", capital: "Antananarivo", tier: "muy_dificil" },
    { country: "Mauricio", capital: "Port Louis", tier: "muy_dificil" },
    { country: "Seychelles", capital: "Victoria", tier: "muy_dificil" },
    { country: "Camer√∫n", capital: "Yaund√©", tier: "muy_dificil" },
    { country: "Gab√≥n", capital: "Libreville", tier: "muy_dificil" },
    { country: "Rep√∫blica del Congo", capital: "Brazzaville", tier: "muy_dificil" },
    { country: "Rep√∫blica Democr√°tica del Congo", capital: "Kinsasa", tier: "muy_dificil" },
    { country: "Rep√∫blica Centroafricana", capital: "Bangui", tier: "muy_dificil" },
    { country: "Chad", capital: "Yamena", tier: "muy_dificil" },
    { country: "N√≠ger", capital: "Niamey", tier: "muy_dificil" },
    { country: "Mal√≠", capital: "Bamako", tier: "muy_dificil" },
    { country: "Burkina Faso", capital: "Uagadug√∫", tier: "muy_dificil" },
    { country: "Ben√≠n", capital: "Porto Novo", tier: "muy_dificil" },
    { country: "Togo", capital: "Lom√©", tier: "muy_dificil" },
    { country: "Costa de Marfil", capital: "Yamusukro", tier: "muy_dificil" },
    { country: "Liberia", capital: "Monrovia", tier: "muy_dificil" },
    { country: "Sierra Leona", capital: "Freetown", tier: "muy_dificil" },
    { country: "Guinea", capital: "Conakri", tier: "muy_dificil" },
    { country: "Guinea-Bis√°u", capital: "Bis√°u", tier: "muy_dificil" },
    { country: "Gambia", capital: "Banjul", tier: "muy_dificil" },
    { country: "Mauritania", capital: "Nuakchot", tier: "muy_dificil" }
];

// ============================================
// GAME.JS - L√≥gica del juego
// ============================================

// Capitales sencillas (las m√°s conocidas)
const CAPITALES_SENCILLAS = [
    "Madrid", "Par√≠s", "Roma", "Berl√≠n", "Londres", "Tokio", "Ciudad de M√©xico",
    "Ottawa", "Brasilia", "Buenos Aires", "Pek√≠n", "Nueva Delhi", "Canberra",
    "Mosc√∫", "Washington D.C.", "El Cairo", "Atenas", "Ankara", "Se√∫l", "Bangkok",
    "Lisboa", "Varsovia", "√Åmsterdam", "Bruselas", "Berna", "Viena", "Estocolmo",
    "Oslo", "Copenhague", "Helsinki", "Dubl√≠n", "Praga", "Budapest", "Bucarest",
    "Santiago", "Bogot√°", "Lima", "Caracas", "Quito", "Yakarta", "Manila",
    "Han√≥i", "Kuala Lumpur", "Singapur", "Pretoria", "Rabat", "Jerusal√©n",
    "Riad", "Teher√°n", "Bagdad"
];

// Configuraci√≥n de dificultad
const DIFFICULTY = {
    beginner: {
        easyCapitalProb: 0.80,  // 80% capitales sencillas
        aiErrorRate: 0.25       // 25% de error (75% de acierto)
    },
    intermediate: {
        easyCapitalProb: 0.60,  // 60% capitales sencillas
        aiErrorRate: 0.12       // 12% de error (88% de acierto)
    },
    advanced: {
        easyCapitalProb: 0.30,  // 30% capitales sencillas
        aiErrorRate: 0.03       // 3% de error (97% de acierto)
    }
};

// Frases inspiracionales
const victoryPhrases = [
    "El conocimiento es tu mejor arma",
    "Cada victoria es un paso hacia la excelencia",
    "Tu dedicaci√≥n ha dado sus frutos",
    "El √©xito llega a quienes perseveran",
    "Has demostrado que puedes con cualquier desaf√≠o"
];

const defeatPhrases = [
    "Cada derrota es una lecci√≥n aprendida",
    "El fracaso es solo el comienzo del √©xito",
    "Sigue adelante, la pr√≥xima vez ser√° mejor",
    "Los grandes campeones se forjan en la adversidad",
    "Cada intento te acerca m√°s a la victoria"
];

const drawPhrases = [
    "Un empate es una batalla bien librada",
    "A veces empatar es ganar experiencia",
    "La igualdad muestra que ambos dieron lo mejor",
    "Un resultado justo para un juego justo",
    "La pr√≥xima vez ser√° decisivo"
];

// Estados del juego
const gameState = {
    playerScore: 0,
    aiScore: 0,
    currentRound: 1,
    maxRounds: 20,
    currentQuestion: null,
    difficulty: 'intermediate', // default
    roundResolved: false, // Flag para evitar doble resoluci√≥n
    timerId: null, // ID del timer actual
    countdownId: null, // ID del countdown inicial
    timerIntervalId: null, // ID del intervalo del timer
    scoreLog: [], // Log interno para tracking de puntos (diagn√≥stico)
    usedCapitals: [] // Capitales ya usadas en esta partida (anti-repetici√≥n)
};

// Referencias DOM
const screens = {
    start: document.getElementById('screen-start'),
    difficulty: document.getElementById('screen-difficulty'),
    game: document.getElementById('screen-game'),
    result: document.getElementById('screen-result'),
    stats: document.getElementById('screen-stats')
};

// Elementos DOM clave
const elements = {
    scorePlayer: document.getElementById('score-player'),
    scoreAI: document.getElementById('score-ai'),
    roundLabel: document.getElementById('round-label'),
    countryLabel: document.getElementById('country-name'),
    answersContainer: document.getElementById('answers'),
    countdownOverlay: document.getElementById('countdown-overlay'),
    countdownText: document.getElementById('countdown-text'),
    timerBar: document.getElementById('timer-bar'),
    resultMessage: document.getElementById('result-message'),
    resultPhrase: document.getElementById('result-phrase')
};

// Inicializaci√≥n
document.addEventListener('DOMContentLoaded', () => {
    initGame();
    setupEventListeners();
    initStats();
    updateStatsUI();
});

// Inicializar estad√≠sticas en localStorage
function initStats() {
    if (!localStorage.getItem('gamesPlayed')) {
        localStorage.setItem('gamesPlayed', '0');
    }
    if (!localStorage.getItem('gamesWon')) {
        localStorage.setItem('gamesWon', '0');
    }
    if (!localStorage.getItem('gamesLost')) {
        localStorage.setItem('gamesLost', '0');
    }
    if (!localStorage.getItem('gamesDraw')) {
        localStorage.setItem('gamesDraw', '0');
    }
}

// Actualizar UI de estad√≠sticas
function updateStatsUI() {
    const gamesPlayed = parseInt(localStorage.getItem('gamesPlayed')) || 0;
    const gamesWon = parseInt(localStorage.getItem('gamesWon')) || 0;
    const gamesLost = parseInt(localStorage.getItem('gamesLost')) || 0;
    const gamesDraw = parseInt(localStorage.getItem('gamesDraw')) || 0;
    
    document.getElementById('stat-games-played').textContent = gamesPlayed;
    document.getElementById('stat-games-won').textContent = gamesWon;
    document.getElementById('stat-games-lost').textContent = gamesLost;
    document.getElementById('stat-games-draw').textContent = gamesDraw;
    
    // Calcular ratio de victoria
    let winRate = '‚Äî';
    if (gamesPlayed > 0) {
        winRate = Math.round((gamesWon / gamesPlayed) * 100) + '%';
    }
    document.getElementById('stat-win-rate').textContent = winRate;
}

// Guardar resultado de partida
function saveGameResult() {
    const gamesPlayed = parseInt(localStorage.getItem('gamesPlayed')) || 0;
    const gamesWon = parseInt(localStorage.getItem('gamesWon')) || 0;
    const gamesLost = parseInt(localStorage.getItem('gamesLost')) || 0;
    const gamesDraw = parseInt(localStorage.getItem('gamesDraw')) || 0;
    
    // Incrementar partidas jugadas
    localStorage.setItem('gamesPlayed', (gamesPlayed + 1).toString());
    
    // Determinar resultado
    const playerWon = gameState.playerScore > gameState.aiScore;
    const isDraw = gameState.playerScore === gameState.aiScore;
    
    if (isDraw) {
        localStorage.setItem('gamesDraw', (gamesDraw + 1).toString());
    } else if (playerWon) {
        localStorage.setItem('gamesWon', (gamesWon + 1).toString());
    } else {
        localStorage.setItem('gamesLost', (gamesLost + 1).toString());
    }
    
    // Actualizar UI
    updateStatsUI();
}

// Funci√≥n para inicializar el juego
function initGame() {
    gameState.playerScore = 0;
    gameState.aiScore = 0;
    gameState.currentRound = 1;
    gameState.currentQuestion = null;
    gameState.roundResolved = false;
    gameState.difficulty = 'intermediate'; // Reset a default
    gameState.scoreLog = []; // Reset log de puntos
    gameState.usedCapitals = []; // Limpiar capitales usadas
    
    // Limpiar timers si existen
    clearTimers();
    
    showScreen('start');
}

// Generar siguiente pregunta seg√∫n dificultad y evitando repetici√≥n
function getNextQuestion(difficulty, usedCapitals) {
    const config = DIFFICULTY[difficulty];
    const shouldUseEasy = Math.random() < config.easyCapitalProb;
    
    // Filtrar capitales disponibles seg√∫n tipo
    let available = QA.filter(q => !usedCapitals.includes(q.capital));
    
    if (available.length === 0) {
        // Si se agotaron todas las capitales, retornar null para terminar partida
        return null;
    }
    
    // Separar en sencillas y no sencillas
    const easyCapitals = available.filter(q => CAPITALES_SENCILLAS.includes(q.capital));
    const hardCapitals = available.filter(q => !CAPITALES_SENCILLAS.includes(q.capital));
    
    let pool = [];
    if (shouldUseEasy && easyCapitals.length > 0) {
        pool = easyCapitals;
    } else if (!shouldUseEasy && hardCapitals.length > 0) {
        pool = hardCapitals;
    } else {
        // Fallback: usar el pool disponible
        pool = easyCapitals.length > 0 ? easyCapitals : hardCapitals;
        if (pool.length === 0) {
            pool = available; // √öltimo recurso: todas las disponibles
        }
    }
    
    if (pool.length === 0) {
        return null; // No hay m√°s preguntas disponibles
    }
    
    // Seleccionar una pregunta aleatoria del pool
    const randomIndex = Math.floor(Math.random() * pool.length);
    const selected = pool[randomIndex];
    
    return selected;
}

// Obtener respuesta de la IA (puede ser correcta o incorrecta seg√∫n tasa de error)
function getAIAnswer(question, difficulty) {
    const config = DIFFICULTY[difficulty];
    const willError = Math.random() < config.aiErrorRate;
    
    if (!willError) {
        // IA acierta: devuelve la capital correcta
        return question.capital;
    } else {
        // IA se equivoca: selecciona una capital incorrecta del dataset
        const allCapitals = QA.map(q => q.capital);
        const wrongCapitals = allCapitals.filter(cap => cap !== question.capital);
        
        if (wrongCapitals.length === 0) {
            // Si no hay opciones incorrectas (muy improbable), devolver la correcta
            return question.capital;
        }
        
        const randomIndex = Math.floor(Math.random() * wrongCapitals.length);
        return wrongCapitals[randomIndex];
    }
}

// Limpiar todos los timers
function clearTimers() {
    if (gameState.timerId) {
        clearTimeout(gameState.timerId);
        gameState.timerId = null;
    }
    if (gameState.countdownId) {
        // countdownId puede ser un timeout o un interval
        clearInterval(gameState.countdownId);
        clearTimeout(gameState.countdownId);
        gameState.countdownId = null;
    }
    if (gameState.timerIntervalId) {
        clearInterval(gameState.timerIntervalId);
        gameState.timerIntervalId = null;
    }
}

// Configurar event listeners
function setupEventListeners() {
    document.getElementById('btn-start').addEventListener('click', showDifficultyScreen);
    document.getElementById('btn-stats').addEventListener('click', () => {
        updateStatsUI();
        showScreen('stats');
    });
    document.getElementById('btn-back').addEventListener('click', () => {
        clearTimers();
        initGame();
        showScreen('start');
    });
    document.getElementById('btn-play-again').addEventListener('click', () => {
        // Reiniciar estado del juego antes de mostrar pantalla de dificultad
        initGame();
        showDifficultyScreen();
    });
    document.getElementById('btn-go-home').addEventListener('click', () => {
        initGame();
        showScreen('start');
    });
    
    // Listeners para cerrar pantalla de stats
    document.getElementById('btn-close-stats').addEventListener('click', () => {
        showScreen('start');
    });
    document.getElementById('btn-close-stats-bottom').addEventListener('click', () => {
        showScreen('start');
    });
    
    // Listeners para botones de dificultad
    document.querySelectorAll('.difficulty-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const difficulty = btn.dataset.difficulty;
            selectDifficulty(difficulty);
        });
    });
}

// Navegaci√≥n entre pantallas
function showScreen(screenName) {
    // Ocultar todas las pantallas primero
    Object.values(screens).forEach(screen => {
        if (screen) {
            screen.classList.remove('active');
            screen.style.display = 'none';
        }
    });
    
    // Mostrar solo la pantalla seleccionada
    if (screens[screenName]) {
        screens[screenName].classList.add('active');
        screens[screenName].style.display = 'block';
    }
    
    if (screenName === 'game') {
        setupGameScreen();
    }
}

// Mostrar pantalla de selecci√≥n de dificultad
function showDifficultyScreen() {
    showScreen('difficulty');
}

// Seleccionar dificultad e iniciar juego
function selectDifficulty(difficulty) {
    // Reiniciar estado del juego antes de iniciar nueva partida
    gameState.playerScore = 0;
    gameState.aiScore = 0;
    gameState.currentRound = 1;
    gameState.currentQuestion = null;
    gameState.roundResolved = false;
    gameState.difficulty = difficulty;
    gameState.usedCapitals = []; // Limpiar capitales usadas al iniciar nueva partida
    
    // Limpiar timers previos
    clearTimers();
    
    showScreen('game');
    startInitialCountdown();
}

// Iniciar countdown inicial (5-4-3-2-1)
function startInitialCountdown() {
    // Limpiar cualquier timer previo antes de iniciar countdown
    clearTimers();
    
    elements.countdownOverlay.classList.add('show');
    elements.countdownText.textContent = '5';
    
    let count = 4;
    // Guardar el ID del intervalo para poder limpiarlo si es necesario
    const countdownInterval = setInterval(() => {
        if (count > 0) {
            elements.countdownText.textContent = count;
            count--;
        } else {
            clearInterval(countdownInterval);
            elements.countdownOverlay.classList.remove('show');
            // Asegurar que el estado est√© correcto antes de iniciar
            gameState.currentRound = 1;
            gameState.playerScore = 0;
            gameState.aiScore = 0;
            gameState.roundResolved = false;
            // Iniciar primera ronda despu√©s del countdown
            startRound();
        }
    }, 1000); // 1 segundo por n√∫mero
    
    // Guardar referencia del countdown
    gameState.countdownId = countdownInterval;
}

// Configurar la pantalla de juego
function setupGameScreen() {
    updateScores();
}

// Actualizar puntuaciones en la UI
function updateScores() {
    elements.scorePlayer.textContent = gameState.playerScore;
    elements.scoreAI.textContent = gameState.aiScore;
    elements.roundLabel.textContent = gameState.currentRound;
}

// Iniciar ronda (sin countdown, directo)
function startRound() {
    // Verificar condiciones de fin de juego ANTES de iniciar ronda
    if (gameState.currentRound > gameState.maxRounds || gameState.playerScore >= 15 || gameState.aiScore >= 15) {
        endGame();
        return;
    }

    // Reset estado de ronda
    gameState.roundResolved = false;
    clearTimers();
    elements.resultMessage.classList.remove('show');
    elements.resultMessage.textContent = '';

    // Iniciar pregunta directamente (sin countdown por ronda)
    startQuestion();
}

// Iniciar pregunta
function startQuestion() {
    // Obtener siguiente pregunta seg√∫n dificultad y evitando repetici√≥n
    const nextQuestion = getNextQuestion(gameState.difficulty, gameState.usedCapitals);
    
    if (nextQuestion === null) {
        // Se agotaron las capitales disponibles
        gameState.capitalsExhausted = true;
        endGame();
        return;
    }
    
    // Guardar pregunta actual
    gameState.currentQuestion = nextQuestion;
    
    // Agregar capital a la lista de usadas
    gameState.usedCapitals.push(nextQuestion.capital);
    
    console.log('Round:', gameState.currentRound, 'Country:', nextQuestion.country, 'Correct:', nextQuestion.capital, 'Difficulty:', gameState.difficulty);
    
    // Generar 4 opciones (1 correcta + 3 distractores)
    const options = generateOptions(nextQuestion.capital);
    
    // Renderizar pregunta y opciones
    renderQuestion();
    renderAnswers(options, nextQuestion.capital);
    
    // Iniciar timer de 5 segundos exactos
    startTimer();
}

// Generar 4 opciones: 1 correcta + 3 distractores
function generateOptions(correctCapital) {
    const options = [correctCapital];
    
    // Obtener todas las capitales del QA (capitales reales)
    const availableCapitals = QA.map(item => item.capital).filter(cap => cap !== correctCapital);
    
    // Seleccionar 3 capitales aleatorias diferentes y sin duplicados
    const selectedCapitals = [];
    while (selectedCapitals.length < 3 && availableCapitals.length > 0) {
        const randomIndex = Math.floor(Math.random() * availableCapitals.length);
        const randomCapital = availableCapitals[randomIndex];
        
        // Asegurar que no haya duplicados
        if (!selectedCapitals.includes(randomCapital) && !options.includes(randomCapital)) {
            selectedCapitals.push(randomCapital);
        }
        availableCapitals.splice(randomIndex, 1);
    }
    
    // Agregar las 3 capitales seleccionadas
    options.push(...selectedCapitals);
    
    // Mezclar las opciones
    return shuffleArray(options);
}

// Mezclar array (algoritmo Fisher-Yates)
function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

// Renderizar pregunta
function renderQuestion() {
    elements.countryLabel.textContent = gameState.currentQuestion.country;
    updateScores();
}

// Renderizar respuestas en grid 2x2
function renderAnswers(options, correctCapital) {
    elements.answersContainer.innerHTML = '';
    
    options.forEach((capital, index) => {
        const btn = document.createElement('button');
        btn.className = 'ans-btn';
        btn.textContent = capital;
        btn.dataset.capital = capital;
        btn.dataset.isCorrect = capital === correctCapital;
        
        btn.addEventListener('click', () => {
            if (!gameState.roundResolved) {
                resolveRound(capital);
            }
        });
        
        elements.answersContainer.appendChild(btn);
    });
}

// Iniciar timer de 5 segundos exactos
function startTimer() {
    elements.timerBar.style.width = '100%';
    elements.timerBar.classList.remove('warning');
    
    const duration = 5000; // 5 segundos exactos
    const startTime = Date.now();
    const updateInterval = 50; // Actualizar cada 50ms para suavidad
    
    const updateTimer = () => {
        if (gameState.roundResolved) {
            return; // Si ya se resolvi√≥, no actualizar
        }
        
        const elapsed = Date.now() - startTime;
        const remaining = Math.max(0, duration - elapsed);
        const percentage = (remaining / duration) * 100;
        
        elements.timerBar.style.width = percentage + '%';
        
        // Cambiar a rojo cuando quede menos de 1 segundo
        if (percentage < 20) {
            elements.timerBar.classList.add('warning');
        }
        
        if (remaining > 0 && !gameState.roundResolved) {
            gameState.timerIntervalId = setTimeout(updateTimer, updateInterval);
        } else if (remaining <= 0 && !gameState.roundResolved) {
            // Tiempo agotado - resolver ronda
            resolveRound(null);
        }
    };
    
    updateTimer();
}

// Sistema de tracking de puntos: agregar punto al jugador
function addPlayerPoint(reason) {
    const before = gameState.playerScore;
    gameState.playerScore++;
    const after = gameState.playerScore;
    
    // Registrar en log
    gameState.scoreLog.push({
        round: gameState.currentRound,
        recipient: 'player',
        reason: reason,
        scoreBefore: before,
        scoreAfter: after,
        timestamp: Date.now()
    });
    
    // Guardar en localStorage para an√°lisis
    try {
        localStorage.setItem('scoreDebug', JSON.stringify(gameState.scoreLog));
    } catch (e) {
        console.warn('Error guardando scoreDebug:', e);
    }
}

// Sistema de tracking de puntos: agregar punto a la IA
function addAIPoint(reason) {
    const before = gameState.aiScore;
    gameState.aiScore++;
    const after = gameState.aiScore;
    
    // Registrar en log
    gameState.scoreLog.push({
        round: gameState.currentRound,
        recipient: 'AI',
        reason: reason,
        scoreBefore: before,
        scoreAfter: after,
        timestamp: Date.now()
    });
    
    // Guardar en localStorage para an√°lisis
    try {
        localStorage.setItem('scoreDebug', JSON.stringify(gameState.scoreLog));
    } catch (e) {
        console.warn('Error guardando scoreDebug:', e);
    }
}

// Resolver ronda (userAnswer puede ser null si se agot√≥ el tiempo)
// ESTA ES LA √öNICA FUNCI√ìN QUE SUMA PUNTOS (a trav√©s de addPlayerPoint/addAIPoint)
function resolveRound(userAnswer) {
    // Verificar flag para evitar doble resoluci√≥n
    if (gameState.roundResolved) {
        return; // Ya se resolvi√≥ esta ronda, no hacer nada
    }
    
    // Marcar como resuelto INMEDIATAMENTE
    gameState.roundResolved = true;
    clearTimers(); // Limpiar timer
    
    const correctCapital = gameState.currentQuestion.capital;
    const userCorrect = userAnswer === correctCapital;
    
    // ACTUALIZAR PUNTUACI√ìN DEL JUGADOR (solo aqu√≠, usando tracking)
    if (userCorrect) {
        addPlayerPoint('respuesta_correcta');
    } else if (userAnswer === null) {
        // Tiempo agotado - no suma punto, pero registramos el evento
        gameState.scoreLog.push({
            round: gameState.currentRound,
            recipient: 'player',
            reason: 'tiempo_agotado',
            scoreBefore: gameState.playerScore,
            scoreAfter: gameState.playerScore,
            timestamp: Date.now()
        });
    } else {
        // Respuesta incorrecta - no suma punto, pero registramos el evento
        gameState.scoreLog.push({
            round: gameState.currentRound,
            recipient: 'player',
            reason: 'respuesta_incorrecta',
            scoreBefore: gameState.playerScore,
            scoreAfter: gameState.playerScore,
            timestamp: Date.now()
        });
    }
    
    // IA resuelve independientemente usando getAIAnswer()
    const aiAnswer = getAIAnswer(gameState.currentQuestion, gameState.difficulty);
    const aiCorrect = aiAnswer === correctCapital;
    
    // ACTUALIZAR PUNTUACI√ìN DE LA IA (solo aqu√≠, usando tracking)
    if (aiCorrect) {
        addAIPoint('respuesta_correcta');
    } else {
        // IA fall√≥ - no suma punto, pero registramos el evento
        gameState.scoreLog.push({
            round: gameState.currentRound,
            recipient: 'AI',
            reason: 'respuesta_incorrecta',
            scoreBefore: gameState.aiScore,
            scoreAfter: gameState.aiScore,
            timestamp: Date.now()
        });
    }
    
    // Guardar log actualizado
    try {
        localStorage.setItem('scoreDebug', JSON.stringify(gameState.scoreLog));
    } catch (e) {
        console.warn('Error guardando scoreDebug:', e);
    }
    
    // Mostrar feedback visual
    showFeedback(userAnswer, correctCapital, userCorrect, aiCorrect);
    
    // Avanzar despu√©s del feedback
    const feedbackDuration = 900 + Math.random() * 300; // Entre 900 y 1200ms
    gameState.timerId = setTimeout(() => {
        nextRoundOrEnd();
    }, feedbackDuration);
}

// Mostrar feedback visual
function showFeedback(userAnswer, correctCapital, userCorrect, aiCorrect) {
    const allButtons = elements.answersContainer.querySelectorAll('.ans-btn');
    
    // Deshabilitar todos los botones
    allButtons.forEach(btn => {
        btn.classList.add('disabled');
    });
    
    // Si el usuario respondi√≥
    if (userAnswer !== null) {
        const userBtn = Array.from(allButtons).find(btn => btn.dataset.capital === userAnswer);
        if (userCorrect) {
            userBtn.classList.add('correct');
        } else {
            userBtn.classList.add('wrong');
        }
    } else {
        // Tiempo agotado - mostrar mensaje
        elements.resultMessage.textContent = '‚è±Ô∏è Tiempo agotado';
        elements.resultMessage.classList.add('show');
    }
    
    // Siempre mostrar la respuesta correcta en verde
    const correctBtn = Array.from(allButtons).find(btn => btn.dataset.capital === correctCapital);
    if (correctBtn && userAnswer !== correctCapital) {
        correctBtn.classList.add('correct');
    }
    
    // Actualizar marcador
    updateScores();
}

// Avanzar a siguiente ronda o terminar juego
function nextRoundOrEnd() {
    // Verificar condiciones de fin de juego
    if (gameState.currentRound >= gameState.maxRounds || gameState.playerScore >= 15 || gameState.aiScore >= 15) {
        endGame();
    } else {
        gameState.currentRound++;
        startRound();
    }
}

// Validar consistencia del sistema de puntos (diagn√≥stico interno)
function validateScoreConsistency() {
    const log = gameState.scoreLog;
    
    // Contar puntos otorgados seg√∫n el log
    const playerPointsFromLog = log.filter(e => e.recipient === 'player' && e.reason === 'respuesta_correcta').length;
    const aiPointsFromLog = log.filter(e => e.recipient === 'AI' && e.reason === 'respuesta_correcta').length;
    
    // Validar que los puntos totales coincidan
    if (playerPointsFromLog !== gameState.playerScore) {
        console.warn(`[Score Debug] Inconsistencia en puntos del jugador: Log=${playerPointsFromLog}, Estado=${gameState.playerScore}`);
    }
    
    if (aiPointsFromLog !== gameState.aiScore) {
        console.warn(`[Score Debug] Inconsistencia en puntos de la IA: Log=${aiPointsFromLog}, Estado=${gameState.aiScore}`);
    }
    
    // Validar que el √∫ltimo evento del log tenga el marcador correcto
    if (log.length > 0) {
        const lastPlayerEvent = [...log].reverse().find(e => e.recipient === 'player');
        const lastAIEvent = [...log].reverse().find(e => e.recipient === 'AI');
        
        if (lastPlayerEvent && lastPlayerEvent.scoreAfter !== gameState.playerScore) {
            console.warn(`[Score Debug] √öltimo evento del jugador no coincide con estado final`);
        }
        
        if (lastAIEvent && lastAIEvent.scoreAfter !== gameState.aiScore) {
            console.warn(`[Score Debug] √öltimo evento de la IA no coincide con estado final`);
        }
    }
    
    // Validar que el n√∫mero de eventos de puntos otorgados sea consistente
    const totalPointEvents = playerPointsFromLog + aiPointsFromLog;
    const totalScore = gameState.playerScore + gameState.aiScore;
    
    if (totalPointEvents !== totalScore) {
        console.warn(`[Score Debug] Total de puntos otorgados (${totalPointEvents}) no coincide con total de marcadores (${totalScore})`);
    }
}

// Terminar juego y mostrar resultado
function endGame() {
    clearTimers();
    
    // Validar consistencia del sistema de puntos (diagn√≥stico interno)
    validateScoreConsistency();
    
    // Verificar si se agotaron las capitales
    if (gameState.capitalsExhausted) {
        const resultIcon = document.getElementById('result-icon');
        const resultTitle = document.getElementById('result-title');
        const resultMessageText = document.getElementById('result-message-text');
        
        resultIcon.textContent = 'üåç';
        resultTitle.textContent = 'Capitales Agotadas';
        resultMessageText.textContent = 'Se agotaron las capitales disponibles. ¬°Has completado todas las preguntas!';
        elements.resultPhrase.textContent = '¬°Incre√≠ble! Has jugado con todas las capitales disponibles.';
        
        document.getElementById('final-player-score').textContent = gameState.playerScore;
        document.getElementById('final-ai-score').textContent = gameState.aiScore;
        document.getElementById('final-rounds').textContent = gameState.currentRound;
        
        // Limpiar flag
        gameState.capitalsExhausted = false;
        
        showScreen('result');
        return;
    }
    
    const playerWon = gameState.playerScore > gameState.aiScore;
    const isDraw = gameState.playerScore === gameState.aiScore;
    
    // Guardar resultado en localStorage
    saveGameResult();
    
    // Actualizar pantalla de resultado
    const resultIcon = document.getElementById('result-icon');
    const resultTitle = document.getElementById('result-title');
    const resultMessageText = document.getElementById('result-message-text');
    
    // Seleccionar frase aleatoria
    let randomPhrase = '';
    if (isDraw) {
        resultIcon.textContent = 'ü§ù';
        resultTitle.textContent = '¬°Empate!';
        resultMessageText.textContent = 'Ambos terminaron con el mismo puntaje';
        randomPhrase = drawPhrases[Math.floor(Math.random() * drawPhrases.length)];
    } else if (playerWon) {
        resultIcon.textContent = 'üéâ';
        resultTitle.textContent = '¬°Victoria!';
        resultMessageText.textContent = 'Has ganado la guerra de capitales';
        randomPhrase = victoryPhrases[Math.floor(Math.random() * victoryPhrases.length)];
    } else {
        resultIcon.textContent = 'üòî';
        resultTitle.textContent = 'Derrota';
        resultMessageText.textContent = 'La IA ha ganado esta vez. ¬°Int√©ntalo de nuevo!';
        randomPhrase = defeatPhrases[Math.floor(Math.random() * defeatPhrases.length)];
    }
    
    // Mostrar frase inspiracional
    elements.resultPhrase.textContent = randomPhrase;
    
    // Actualizar estad√≠sticas finales
    document.getElementById('final-player-score').textContent = gameState.playerScore;
    document.getElementById('final-ai-score').textContent = gameState.aiScore;
    document.getElementById('final-rounds').textContent = gameState.currentRound;
    
    showScreen('result');
}
    </script>
</body>
</html>

